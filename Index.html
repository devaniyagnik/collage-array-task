<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Table</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/css/bootstrap.min.css"
      integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh"
      crossorigin="anonymous"
    />
    <script src="./js/Api.js"></script>
    <!-- // style  -->
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      .form {
        padding: 10px;
      }
      table {
        width: 100%;
      }
    </style>
  </head>
  <body>
    <div class="fluid-container">
      <div class="form">
        <select name="gender" id="gender" multiple>
          <option value="">Select</option>
          <option value="Male">Male</option>
          <option value="Female">Female</option>
        </select>
        <select name="department" id="department" multiple>
          <option value="">Select</option>
          <option value="Computer">Computer</option>
          <option value="Automobile">Automobile</option>
          <option value="Civil">Civil</option>
        </select>
        <select name="year" id="year" multiple>
          <option value="">Select</option>
          <option value="First">First</option>
          <option value="Second">Second</option>
          <option value="Third">Third</option>
          <option value="Fourth">Fourth</option>
          <option value="Pass Out">Pass Out</option>
        </select>

        <br /><br />
        <input
          type="number"
          name="merit"
          id="merit"
          min="0"
          max="99"
          placeholder="merit"
          required
        />
        <select name="conditioninmerit" id="conditioninmerit">
          <option value="">Select</option>
          <option value="lessthan">less than</option>
          <option value="greaterthan">greater than</option>
        </select>

        <br /><br />
        <select name="studenttype" id="studenttype" multiple>
          <option value="">Select</option>
          <option value="merit_12th">Regular</option>
          <option value="merit_diploma">D2D</option>
        </select>

        <button id="submit">Filter</button>
        <button id="duplicate">duplicate</button>
        <button id="sorting">sorting</button>
        <br /><br />

        <select name="meritsortingtype" id="meritsortingtype" multiple>
          <option value="">Select</option>
          <option value="ascending">ascending order</option>
          <option value="descending">descending order</option>
        </select>
        <button id="sortingonmerit">sort in merit</button>
        <button id="reset">reset</button>
        <button id="download">Download</button>
      </div>
      <table border="1px">
        <thead>
          <th>id</th>
          <th>student_name</th>
          <th>gender</th>
          <th>contact_number</th>
          <th>email_id</th>
          <th>admission_year</th>
          <th>merit_12th</th>
          <th>year</th>
          <th>department</th>
          <th>dep_head</th>
          <th>year_head</th>
        </thead>
        <tbody id="myTablebody"></tbody>
      </table>
    </div>

    <script>
      const submit = document.getElementById("submit");
      const duplicate = document.getElementById("duplicate");
      const download = document.getElementById("download");
      const sorting = document.getElementById("sorting");
      const reset = document.getElementById("reset");
      const sortingonmerit = document.getElementById("sortingonmerit");
      const all = document.getElementById("all");

      const meritfilter = document.getElementById("meritfilter");
      const dropdown = document.querySelector(".yeartype");
      const studentfilter = document.getElementById("studentfilter");

      var getallvalue = "All";
      var getmeritsortvalue = "All";
      var resetbul = "";
      var getgendervalue = [];
      var getyearvalue = [];
      var getdepartmentvalue = [];
      var getmeritvalue = [];
      var getconditioninmerit = [];
      var getstudenttype = [];
      var arrayforphonenumber = [];
      var duplicatebol = false;
      const Tablebody = document.getElementById("myTablebody");
      const clearTable = () => {
        Tablebody.innerHTML = "";
      };
      console.log(data);
      var newarray = [];
      var oldarray = [data.department_data];

      let duplicatesnumber = [];
      var getidof12th = [];
      var alldatasetinstudentid = [];

      const modify_data = () => {
        newarray.splice(0, newarray.length);
        oldarray.splice(0, oldarray.length);

        const tableRows = data.department_data.forEach((departmentitem) => {
          const dep_head = departmentitem.dep_head;
          const department = departmentitem.department;

          departmentitem.year?.forEach((years) => {
            const yearData = {
              year: years.year,
              year_head: years.year_head,
              student_data: [],
            };
            const year = years.year;
            const year_head = years.year_head;

            years.student_data.forEach((student) => {
              if (duplicatebol) {
                duplicatesnumber = arrayforphonenumber.filter(
                  (number, index, array) => {
                    return array.filter((num) => num === number).length >= 2;
                  }
                );
              }

              if (
                (getgendervalue.length === 0 || getgendervalue.includes("")
                  ? true
                  : getgendervalue.includes(student.gender)) &&
                (getdepartmentvalue.length === 0 ||
                getdepartmentvalue.includes("")
                  ? true
                  : getdepartmentvalue.includes(department)) &&
                (getyearvalue.length === 0 || getyearvalue.includes("")
                  ? true
                  : getyearvalue.includes(year)) &&
                (getmeritvalue
                  ? getconditioninmerit === "lessthan"
                    ? getmeritvalue > student.merit_12th ||
                      getmeritvalue > student.merit_deploma
                    : true
                  : true) &&
                (getmeritvalue
                  ? getconditioninmerit === "greaterthan"
                    ? getmeritvalue < student.merit_12th ||
                      getmeritvalue < student.merit_deploma
                    : true
                  : true) &&
                (getstudenttype.length === 0 || getstudenttype.includes("")
                  ? true
                  : Object.keys(student).some((e) =>
                      getstudenttype.includes(e)
                    )) &&
                (duplicatebol
                  ? duplicatesnumber.includes(student.contact_number)
                  : true)
              ) {
                /// store value in oldarray
                const meritaddValue = student.hasOwnProperty("merit_12th")
                  ? "merit_12th"
                  : "merit_diploma";
                const studentData = {
                  id: student.id,
                  student_name: student.student_name,
                  gender: student.gender,
                  contact_number: student.contact_number,
                  email_id: student.email_id,
                  admission_year: student.admission_year,
                };
                studentData[meritaddValue] =
                  student.merit_12th || student.merit_diploma;
                yearData.student_data.push(studentData);

                /// store value in newarray
                newarray.push({
                  id: student.id,
                  student_name: student.student_name,
                  contact_number: student.contact_number,
                  email_id: student.email_id,
                  admission_year: student.admission_year,
                  gender: student.gender,
                  merit_12th: student.merit_12th || student.merit_diploma,
                  year: year,
                  year_head: year_head,
                  dep_head: dep_head,
                  department: department,
                });
              }
            });
            if (yearData.student_data.length > 0) {
              const departmentIndex = oldarray.findIndex(
                (item) => item.department === department
              );

              if (departmentIndex === -1) {
                oldarray.push({
                  department: department,
                  dep_head: departmentitem.dep_head,
                  year: [yearData],
                });
              } else {
                oldarray[departmentIndex].year.push(yearData);
              }
            }
          });
        });
      };
      //hi

      const printtable = () => {
        arrayforphonenumber = [];

        newarray.forEach((student) => {
          arrayforphonenumber.push(student.contact_number);
          const row = document.createElement("tr");
          const cell5 = document.createElement("td");
          cell5.textContent = student.id;
          const cell6 = document.createElement("td");
          cell6.textContent = student.student_name;
          const cell7 = document.createElement("td");
          cell7.textContent = student.gender;
          const cell8 = document.createElement("td");
          cell8.textContent = student.contact_number;
          const cell9 = document.createElement("td");
          cell9.textContent = student.email_id;
          const cell10 = document.createElement("td");
          cell10.textContent = student.admission_year;
          const cell11 = document.createElement("td");
          cell11.textContent = student.merit_12th || student.merit_diploma;
          const cell1 = document.createElement("td");
          cell1.textContent = student.year;
          const cell2 = document.createElement("td");
          cell2.textContent = student.department;
          const cell3 = document.createElement("td");
          cell3.textContent = student.dep_head;
          const cell4 = document.createElement("td");
          cell4.textContent = student.year_head;

          row.appendChild(cell5);
          row.appendChild(cell6);
          row.appendChild(cell7);
          row.appendChild(cell8);
          row.appendChild(cell9);
          row.appendChild(cell10);
          row.appendChild(cell11);
          row.appendChild(cell1);
          row.appendChild(cell2);
          row.appendChild(cell3);
          row.appendChild(cell4);
          Tablebody.appendChild(row);
        });
      };
      modify_data();
      console.log(oldarray);
      printtable();
      duplicate.addEventListener("click", function () {
        duplicatebol = true;
        clearTable();
        modify_data();

        printtable();
        console.log(newarray);
        console.log(oldarray);
        duplicatebol = false;
      });

      reset.addEventListener("click", function () {
        getallvalue = "All";
        getmeritsortvalue = "All";
        resetbul = "";
        getgendervalue = [];
        getyearvalue = [];
        getdepartmentvalue = [];
        getmeritvalue = [];
        getconditioninmerit = [];
        getstudenttype = [];
        arrayforphonenumber = [];
        duplicatebol = false;
        gender.value = gender.defaultSelected;
        department.value = department.defaultSelected;
        year.value = year.defaultSelected;
        merit.value = merit.defaultSelected;
        studenttype.value = studenttype.defaultSelected;
        conditioninmerit.value = conditioninmerit.defaultSelected;
        clearTable();
        modify_data();
        printtable();
      });
      sorting.addEventListener("click", function () {
        duplicatebol = true;
        clearTable();
        modify_data();
        newarray.sort((a, b) => a.contact_number - b.contact_number);
        printtable();
        console.log(newarray);
        console.log(oldarray);
        duplicatebol = false;
      });
      sortingonmerit.addEventListener("click", function () {
        getmeritsortvalue = Array.from(meritsortingtype.selectedOptions).map(
          (meritsortingtype) => meritsortingtype.value
        );
        console.log(getmeritsortvalue);

        clearTable();
        modify_data();

        getmeritsortvalue
          ? getmeritsortvalue.includes("ascending")
            ? newarray.sort((a, b) => a.merit_12th - b.merit_12th)
            : true
          : true;

        getmeritsortvalue
          ? getmeritsortvalue.includes("descending")
            ? newarray.sort((a, b) => b.merit_12th - a.merit_12th)
            : true
          : true;
        printtable();
        console.log(newarray);
        console.log(oldarray);
      });
      download.addEventListener("click", function () {
        //define the heading for each row of the data
        var csv =
          "id,	student_name,	gender,	contact_number,	email_id,	admission_year,	merit_12th,	year,	department,	dep_head,	year_head\n"; // Add column headers

        //merge the data with CSV
        newarray.forEach(function (row) {
          csv += row.id + ",";
          csv += row.student_name + ",";
          csv += row.gender + ",";
          csv += row.contact_number + ",";
          csv += row.email_id + ",";
          csv += row.admission_year + ",";
          csv += row.merit_12th + ",";
          csv += row.year + ",";
          csv += row.department + ",";
          csv += row.dep_head + ",";
          csv += row.year_head + "\n";
        });

        //display the created CSV data on the web browser
        console.log(csv);

        var hiddenElement = document.createElement("a");
        hiddenElement.href = "data:text/csv;charset=utf-8," + encodeURI(csv);
        hiddenElement.target = "_blank";

        //provide the name for the CSV file to be downloaded
        hiddenElement.download = "Filterdata.csv";
        hiddenElement.click();
      });
      submit.addEventListener("click", function () {
        getgendervalue = Array.from(gender.selectedOptions).map(
          (gender) => gender.value
        );
        getdepartmentvalue = Array.from(department.selectedOptions).map(
          (department) => department.value
        );
        getyearvalue = Array.from(year.selectedOptions).map(
          (year) => year.value
        );
        getstudenttype = Array.from(studenttype.selectedOptions).map(
          (studenttype) => studenttype.value
        );
        getmeritvalue = merit.value;
        getconditioninmerit = conditioninmerit.value;

        console.log(getgendervalue);
        clearTable();
        modify_data();

        printtable();

        console.log(newarray);
        console.log(oldarray);
      });
    </script>
  </body>
</html>
